<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ topic_name }} // Mastery</title>
    <!-- SECURITY: CSRF Token for AJAX -->
    <meta name="csrf-token" content="{{ csrf_token() }}">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg: #030303; --card: #0a0a0a; --border: rgba(255,255,255,0.08); --primary: #6366f1; --success: #10b981; }
        body { background: var(--bg); color: #fff; font-family: 'Inter', sans-serif; overflow-x: hidden; }

        /* HUD & Progress */
        .glass-hud { background: rgba(10, 10, 10, 0.6); backdrop-filter: blur(16px); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 50; }
        .liquid-bar-bg { background: rgba(255,255,255,0.05); height: 6px; border-radius: 99px; overflow: hidden; position: relative; }
        .liquid-bar-fill { height: 100%; border-radius: 99px; transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); position: relative; }
        .liquid-bar-fill::after { content: ''; position: absolute; top: 0; left: 0; bottom: 0; right: 0; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent); transform: translateX(-100%); animation: shimmer 2s infinite; }

        /* Problem Row */
        .problem-row { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 16px 24px; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); position: relative; overflow: hidden; transform-origin: center; }
        .problem-row::before { content: ''; position: absolute; inset: 0; background: radial-gradient(600px circle at var(--mouse-x) var(--mouse-y), rgba(255,255,255,0.04), transparent 40%); opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .problem-row:hover::before { opacity: 1; }
        .problem-row:hover { border-color: rgba(255,255,255,0.2); transform: translateY(-2px) scale(1.005); box-shadow: 0 10px 30px -10px rgba(0,0,0,0.5); z-index: 10; }
        
        .problem-row.solved { background: rgba(16, 185, 129, 0.03); border-color: rgba(16, 185, 129, 0.2); }
        .problem-row.solved .problem-title { color: #6b7280; }

        /* Strikethrough */
        .problem-title { position: relative; display: inline-block; transition: color 0.3s; }
        .strikethrough-line { position: absolute; top: 50%; left: 0; width: 0%; height: 2px; background: #10b981; border-radius: 2px; transition: width 0.4s cubic-bezier(0.65, 0, 0.35, 1); pointer-events: none; box-shadow: 0 0 8px rgba(16, 185, 129, 0.5); }
        .problem-row.solved .strikethrough-line { width: 100%; }

        /* Checkbox */
        .checkbox-wrapper { width: 24px; height: 24px; border-radius: 6px; border: 2px solid #52525b; background: rgba(0,0,0,0.3); display: grid; place-items: center; cursor: pointer; transition: all 0.2s; overflow: hidden; }
        .checkbox-wrapper:hover { border-color: #71717a; }
        .problem-row.solved .checkbox-wrapper { background: #10b981; border-color: #10b981; box-shadow: 0 0 15px rgba(16, 185, 129, 0.4); }
        .checkmark-path { stroke-dasharray: 20; stroke-dashoffset: 20; transition: stroke-dashoffset 0.3s cubic-bezier(0.65, 0, 0.45, 1); }
        .problem-row.solved .checkmark-path { stroke-dashoffset: 0; }

        @keyframes shimmer { 100% { transform: translateX(100%); } }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
        
        .badge { font-size: 10px; font-family: 'JetBrains Mono', monospace; padding: 4px 8px; border-radius: 4px; font-weight: 700; text-transform: uppercase; }
        .badge-Easy { background: rgba(52, 211, 153, 0.1); color: #34d399; }
        .badge-Medium { background: rgba(251, 191, 36, 0.1); color: #fbbf24; }
        .badge-Hard { background: rgba(248, 113, 113, 0.1); color: #f87171; }

        .filter-btn { opacity: 0.5; transition: 0.2s; }
        .filter-btn:hover { opacity: 0.8; }
        .filter-btn.active { opacity: 1; color: var(--primary); font-weight: 600; }
    </style>
</head>
<body class="min-h-screen pb-20">

    <!-- HEADER HUD -->
    <div class="glass-hud">
        <div class="max-w-5xl mx-auto px-6 py-6">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <a href="{{ url_for('index') }}" class="text-xs font-bold text-gray-500 hover:text-white uppercase tracking-widest mb-1 block transition-colors">
                        &larr; Main Operations
                    </a>
                    <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight text-white flex items-center gap-3">
                        <span class="bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-400">{{ topic_name }}</span>
                    </h1>
                </div>
                <div class="text-right">
                    <div class="text-xs text-gray-400 font-mono mb-1">MODULE PROGRESS</div>
                    <div class="text-3xl font-bold text-indigo-400 font-mono tracking-tighter" id="total-progress">0%</div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <div class="flex justify-between text-xs font-semibold mb-2 text-green-400"><span>EASY</span><span id="easy-text">0/0</span></div>
                    <div class="liquid-bar-bg"><div id="easy-bar" class="liquid-bar-fill bg-green-500" style="width: 0%"></div></div>
                </div>
                <div>
                    <div class="flex justify-between text-xs font-semibold mb-2 text-yellow-400"><span>MEDIUM</span><span id="medium-text">0/0</span></div>
                    <div class="liquid-bar-bg"><div id="medium-bar" class="liquid-bar-fill bg-yellow-500" style="width: 0%"></div></div>
                </div>
                <div>
                    <div class="flex justify-between text-xs font-semibold mb-2 text-red-400"><span>HARD</span><span id="hard-text">0/0</span></div>
                    <div class="liquid-bar-bg"><div id="hard-bar" class="liquid-bar-fill bg-red-500" style="width: 0%"></div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- CONTROLS -->
    <div class="max-w-5xl mx-auto px-6 mt-8 mb-6 flex justify-between items-end border-b border-gray-800 pb-4">
        <div class="flex gap-6 text-sm">
            <button class="filter-btn active" onclick="filterList('all', this)">ALL MISSIONS</button>
            <button class="filter-btn" onclick="filterList('active', this)">ACTIVE</button>
            <button class="filter-btn" onclick="filterList('completed', this)">COMPLETED</button>
        </div>
        <div class="text-xs text-gray-600 font-mono">SYNC: <span class="text-green-500">ONLINE</span></div>
    </div>

    <!-- LIST -->
    <div id="problem-container" class="max-w-5xl mx-auto px-6 space-y-3"></div>

    <script>
        const allProblems = {{ problems | tojson | safe }};
        let solvedIds = new Set();
        // 1. Get the Token from the meta tag
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        document.addEventListener("mousemove", (e) => {
            const cards = document.querySelectorAll(".problem-row");
            cards.forEach(card => {
                const rect = card.getBoundingClientRect();
                card.style.setProperty("--mouse-x", `${e.clientX - rect.left}px`);
                card.style.setProperty("--mouse-y", `${e.clientY - rect.top}px`);
            });
        });

        async function init() {
            try {
                const res = await fetch('/api/progress');
                if (res.ok) {
                    const data = await res.json();
                    solvedIds = new Set(Object.keys(data));
                }
            } catch(e) {}
            render();
            updateStats();
        }

        function render(filterType = 'all') {
            const container = document.getElementById('problem-container');
            container.innerHTML = '';

            allProblems.forEach((p, index) => {
                const isSolved = solvedIds.has(String(p.ID));
                if (filterType === 'active' && isSolved) return;
                if (filterType === 'completed' && !isSolved) return;

                const row = document.createElement('div');
                row.className = `problem-row flex items-center justify-between group ${isSolved ? 'solved' : ''}`;
                row.style.animation = `fadeInUp 0.4s ease forwards ${index * 0.05}s`;
                row.style.opacity = '0'; row.style.transform = 'translateY(10px)';

                row.innerHTML = `
                    <div class="flex items-center gap-5 z-10 w-full">
                        <div class="checkbox-wrapper" onclick="handleCheck(${p.ID}, this, event)">
                            <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                                <path class="checkmark-path" d="M11.6666 3.5L5.24992 9.91667L2.33325 7" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-baseline justify-between">
                                <a href="${p.Link}" target="_blank" class="problem-title text-lg font-medium text-gray-100 group-hover:text-indigo-300 transition-colors">
                                    ${p.Title}
                                    <span class="strikethrough-line"></span>
                                </a>
                                <span class="text-xs font-mono text-gray-600">#${p.ID}</span>
                            </div>
                            <div class="flex items-center gap-3 mt-2">
                                <span class="badge badge-${p.Difficulty}">${p.Difficulty}</span>
                                <span class="text-xs text-gray-500 font-medium">Acc: ${p.AcceptanceRate}%</span>
                                <span class="text-xs text-gray-600">â€¢</span>
                                <span class="text-xs text-gray-500 font-medium">${p.adjusted_like_ratio.toFixed(0)}% Likes</span>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(row);
            });
        }

        async function handleCheck(id, btn, event) {
            const sid = String(id);
            const isSolving = !solvedIds.has(sid);
            const row = btn.closest('.problem-row');

            if (isSolving) {
                solvedIds.add(sid);
                row.classList.add('solved');
                triggerConfetti(event.clientX, event.clientY);
            } else {
                solvedIds.delete(sid);
                row.classList.remove('solved');
            }
            updateStats();

            try {
                await fetch('/api/progress/toggle', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken // <--- CRITICAL FIX
                    },
                    body: JSON.stringify({problem_id: id, solved: isSolving})
                });
            } catch(e) { console.error("Sync failed"); }
        }

        function triggerConfetti(x, y) {
            const xNorm = x / window.innerWidth;
            const yNorm = y / window.innerHeight;
            confetti({ particleCount: 60, spread: 70, origin: { x: xNorm, y: yNorm }, colors: ['#6366f1', '#10b981', '#ffffff'], disableForReducedMotion: true, gravity: 1.2, scalar: 0.8, ticks: 100 });
        }

        function updateStats() {
            const counts = { Easy: {total:0, done:0}, Medium: {total:0, done:0}, Hard: {total:0, done:0} };
            let totalDone = 0;
            allProblems.forEach(p => {
                counts[p.Difficulty].total++;
                if (solvedIds.has(String(p.ID))) {
                    counts[p.Difficulty].done++;
                    totalDone++;
                }
            });
            document.getElementById('total-progress').innerText = `${Math.round((totalDone / allProblems.length) * 100) || 0}%`;
            updateBar('easy', counts.Easy); updateBar('medium', counts.Medium); updateBar('hard', counts.Hard);
        }

        function updateBar(type, data) {
            const pct = data.total === 0 ? 0 : Math.round((data.done / data.total) * 100);
            document.getElementById(`${type}-bar`).style.width = `${pct}%`;
            document.getElementById(`${type}-text`).innerText = `${data.done}/${data.total}`;
        }

        function filterList(type, btn) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            render(type);
        }

        init();
    </script>
</body>
</html>